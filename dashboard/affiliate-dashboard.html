<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Dashboard - OMNI-MIND</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .affiliate-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 5px;
        }

        .affiliate-code {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #f0f0ff;
            border: 2px solid #6366f1;
            border-radius: 6px;
            font-weight: 700;
            color: #6366f1;
        }

        .copy-btn {
            padding: 6px 12px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .tier-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-radius: 8px;
            font-weight: 700;
            font-size: 18px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .stat-change {
            font-size: 13px;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 20px;
        }

        .referral-link-box {
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .referral-link {
            flex: 1;
            padding: 10px;
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
        }

        .commission-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .commission-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .commission-item:last-child {
            border-bottom: none;
        }

        .commission-date {
            font-size: 12px;
            color: #999;
        }

        .commission-product {
            font-weight: 600;
            color: #1a1a1a;
            margin: 5px 0;
        }

        .commission-amount {
            font-size: 18px;
            font-weight: 700;
            color: #10b981;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 5px;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-paid {
            background: #e0f2fe;
            color: #075985;
        }

        .payout-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .payout-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .payout-item:last-child {
            border-bottom: none;
        }

        .payout-amount {
            font-size: 20px;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 5px;
        }

        .payout-date {
            font-size: 13px;
            color: #666;
        }

        .marketing-materials {
            display: grid;
            gap: 15px;
        }

        .material-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .material-item:hover {
            background: #f0f0f0;
        }

        .material-icon {
            font-size: 32px;
        }

        .material-info {
            flex: 1;
        }

        .material-title {
            font-weight: 600;
            color: #1a1a1a;
        }

        .material-description {
            font-size: 13px;
            color: #666;
        }

        .download-btn {
            padding: 8px 16px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .tips-list {
            list-style: none;
            padding: 0;
        }

        .tips-list li {
            padding: 12px 0;
            padding-left: 30px;
            position: relative;
            border-bottom: 1px solid #e0e0e0;
        }

        .tips-list li:last-child {
            border-bottom: none;
        }

        .tips-list li:before {
            content: "üí°";
            position: absolute;
            left: 0;
        }

        .alert-box {
            padding: 15px 20px;
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-box.success {
            background: #d1fae5;
            border-left-color: #10b981;
        }

        .alert-title {
            font-weight: 700;
            margin-bottom: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="affiliate-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-left">
                <h1>ü§ù Affiliate Dashboard</h1>
                <div class="affiliate-code" id="affiliateCodeDisplay">
                    Code: <span id="affiliateCode">Loading...</span>
                    <button class="copy-btn" onclick="copyAffiliateCode()">Copy</button>
                </div>
            </div>
            <div class="tier-badge" id="tierBadge">
                <span id="tierIcon">ü•â</span>
                <span id="tierName">Bronze Tier</span>
            </div>
        </div>

        <!-- Status Alert -->
        <div class="alert-box" id="statusAlert" style="display: none;">
            <div class="alert-title" id="alertTitle"></div>
            <div id="alertMessage"></div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-label">Total Earnings</div>
                <div class="stat-value" id="totalEarnings">$0.00</div>
                <div class="stat-change positive" id="earningsChange"></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíµ</div>
                <div class="stat-label">Pending Commission</div>
                <div class="stat-value" id="pendingCommission">$0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-label">Total Clicks</div>
                <div class="stat-value" id="totalClicks">0</div>
                <div class="stat-change" id="clicksChange"></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-label">Conversions</div>
                <div class="stat-value" id="totalConversions">0</div>
                <div class="stat-change" id="conversionsChange"></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-label">Conversion Rate</div>
                <div class="stat-value" id="conversionRate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí≥</div>
                <div class="stat-label">Total Paid Out</div>
                <div class="stat-value" id="totalPaidOut">$0.00</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content-grid">
            <div>
                <!-- Referral Links -->
                <div class="card">
                    <h2 class="card-title">Your Referral Links</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Share these links to earn commission. Track clicks and conversions in real-time.
                    </p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">Main Landing Page</label>
                        <div class="referral-link-box">
                            <input type="text" class="referral-link" id="mainLink" readonly>
                            <button class="copy-btn" onclick="copyLink('mainLink')">Copy</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">Checkout Page</label>
                        <div class="referral-link-box">
                            <input type="text" class="referral-link" id="checkoutLink" readonly>
                            <button class="copy-btn" onclick="copyLink('checkoutLink')">Copy</button>
                        </div>
                    </div>

                    <div>
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">Register Page</label>
                        <div class="referral-link-box">
                            <input type="text" class="referral-link" id="registerLink" readonly>
                            <button class="copy-btn" onclick="copyLink('registerLink')">Copy</button>
                        </div>
                    </div>
                </div>

                <!-- Recent Commissions -->
                <div class="card" style="margin-top: 30px;">
                    <h2 class="card-title">Recent Commissions</h2>
                    <div class="commission-list" id="commissionsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div>No commissions yet. Start promoting to earn!</div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <!-- Payout History -->
                <div class="card">
                    <h2 class="card-title">Payout History</h2>
                    <div class="payout-history" id="payoutHistory">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí∏</div>
                            <div>No payouts yet</div>
                        </div>
                    </div>
                </div>

                <!-- Marketing Materials -->
                <div class="card" style="margin-top: 30px;">
                    <h2 class="card-title">Marketing Materials</h2>
                    <div class="marketing-materials">
                        <div class="material-item" onclick="downloadMaterial('banners')">
                            <div class="material-icon">üé®</div>
                            <div class="material-info">
                                <div class="material-title">Banner Images</div>
                                <div class="material-description">Various sizes for web & social</div>
                            </div>
                            <button class="download-btn">Download</button>
                        </div>
                        <div class="material-item" onclick="downloadMaterial('email')">
                            <div class="material-icon">üìß</div>
                            <div class="material-info">
                                <div class="material-title">Email Templates</div>
                                <div class="material-description">Ready-to-use email copy</div>
                            </div>
                            <button class="download-btn">Download</button>
                        </div>
                        <div class="material-item" onclick="downloadMaterial('social')">
                            <div class="material-icon">üì±</div>
                            <div class="material-info">
                                <div class="material-title">Social Media Posts</div>
                                <div class="material-description">Pre-written posts & images</div>
                            </div>
                            <button class="download-btn">Download</button>
                        </div>
                    </div>
                </div>

                <!-- Tips -->
                <div class="card" style="margin-top: 30px;">
                    <h2 class="card-title">Success Tips</h2>
                    <ul class="tips-list">
                        <li>Share personal success stories with OMNI-MIND</li>
                        <li>Create tutorial videos showing features</li>
                        <li>Write blog posts about AI content creation</li>
                        <li>Share before/after examples of generated content</li>
                        <li>Engage with your audience and answer questions</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let affiliateData = null;

        async function loadAffiliateData() {
            try {
                const response = await ApiClient.get('/api/affiliates/dashboard');
                affiliateData = response.data || response;
                
                // Update status alert
                if (affiliateData.status === 'pending') {
                    document.getElementById('statusAlert').style.display = 'block';
                    document.getElementById('alertTitle').textContent = '‚è≥ Application Pending';
                    document.getElementById('alertMessage').textContent = 'Your affiliate application is under review. We\'ll notify you once approved.';
                } else if (affiliateData.status === 'active') {
                    document.getElementById('statusAlert').style.display = 'block';
                    document.getElementById('statusAlert').classList.add('success');
                    document.getElementById('alertTitle').textContent = '‚úÖ Account Active';
                    document.getElementById('alertMessage').textContent = 'Your affiliate account is active and earning commissions!';
                } else if (affiliateData.status === 'suspended') {
                    document.getElementById('statusAlert').style.display = 'block';
                    document.getElementById('alertTitle').textContent = 'üö´ Account Suspended';
                    document.getElementById('alertMessage').textContent = 'Your affiliate account has been suspended. Please contact support.';
                }
                
                // Update affiliate code
                document.getElementById('affiliateCode').textContent = affiliateData.affiliate_code;
                
                // Update tier
                updateTierBadge(affiliateData.tier);
                
                // Update stats
                document.getElementById('totalEarnings').textContent = `$${affiliateData.total_commissions_earned.toFixed(2)}`;
                document.getElementById('pendingCommission').textContent = `$${affiliateData.pending_commission.toFixed(2)}`;
                document.getElementById('totalClicks').textContent = affiliateData.total_clicks.toLocaleString();
                document.getElementById('totalConversions').textContent = affiliateData.total_conversions.toLocaleString();
                document.getElementById('totalPaidOut').textContent = `$${affiliateData.total_commissions_paid.toFixed(2)}`;
                
                const conversionRate = affiliateData.total_clicks > 0 
                    ? ((affiliateData.total_conversions / affiliateData.total_clicks) * 100).toFixed(2)
                    : 0;
                document.getElementById('conversionRate').textContent = `${conversionRate}%`;
                
                // Update referral links
                const baseUrl = window.location.origin;
                document.getElementById('mainLink').value = `${baseUrl}/?ref=${affiliateData.affiliate_code}`;
                document.getElementById('checkoutLink').value = `${baseUrl}/dashboard/checkout.html?ref=${affiliateData.affiliate_code}`;
                document.getElementById('registerLink').value = `${baseUrl}/dashboard/register.html?ref=${affiliateData.affiliate_code}`;
                
                // Load commissions
                loadCommissions();
                
                // Load payouts
                loadPayouts();
                
            } catch (error) {
                console.error('Error loading affiliate data:', error);
                if (error.message.includes('not found') || error.message.includes('Not an affiliate')) {
                    // Not an affiliate yet - redirect to registration
                    if (confirm('You are not registered as an affiliate yet. Would you like to apply?')) {
                        window.location.href = 'affiliate-register.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                }
            }
        }

        function updateTierBadge(tier) {
            const tierIcons = {
                'bronze': 'ü•â',
                'silver': 'ü•à',
                'gold': 'ü•á',
                'platinum': 'üíé'
            };
            const tierNames = {
                'bronze': 'Bronze Tier',
                'silver': 'Silver Tier',
                'gold': 'Gold Tier',
                'platinum': 'Platinum Tier'
            };
            
            document.getElementById('tierIcon').textContent = tierIcons[tier] || 'ü•â';
            document.getElementById('tierName').textContent = tierNames[tier] || 'Bronze Tier';
        }

        async function loadCommissions() {
            try {
                const response = await ApiClient.get('/api/affiliates/commissions');
                const commissions = response.data || [];
                
                const list = document.getElementById('commissionsList');
                if (commissions.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div>No commissions yet. Start promoting to earn!</div>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = commissions.map(comm => {
                    const statusClass = `status-${comm.status}`;
                    return `
                        <div class="commission-item">
                            <div>
                                <div class="commission-date">${new Date(comm.created_at).toLocaleDateString()}</div>
                                <div class="commission-product">${comm.product_name || 'Product Purchase'}</div>
                                <span class="status-badge ${statusClass}">${comm.status.toUpperCase()}</span>
                            </div>
                            <div class="commission-amount">$${comm.commission_amount_usd.toFixed(2)}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading commissions:', error);
            }
        }

        async function loadPayouts() {
            try {
                const response = await ApiClient.get('/api/affiliates/payouts');
                const payouts = response.data || [];
                
                const history = document.getElementById('payoutHistory');
                if (payouts.length === 0) {
                    history.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üí∏</div>
                            <div>No payouts yet</div>
                        </div>
                    `;
                    return;
                }
                
                history.innerHTML = payouts.map(payout => `
                    <div class="payout-item">
                        <div class="payout-amount">$${payout.amount_usd.toFixed(2)}</div>
                        <div class="payout-date">
                            ${new Date(payout.completed_at || payout.created_at).toLocaleDateString()} 
                            via ${formatPayoutMethod(payout.payout_method)}
                        </div>
                        <span class="status-badge status-${payout.status}">${payout.status.toUpperCase()}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading payouts:', error);
            }
        }

        function formatPayoutMethod(method) {
            const methods = {
                'paypal': 'PayPal',
                'bank_transfer': 'Bank Transfer',
                'stripe': 'Stripe'
            };
            return methods[method] || method;
        }

        function copyAffiliateCode() {
            const code = document.getElementById('affiliateCode').textContent;
            navigator.clipboard.writeText(code);
            alert('Affiliate code copied to clipboard!');
        }

        function copyLink(linkId) {
            const input = document.getElementById(linkId);
            input.select();
            navigator.clipboard.writeText(input.value);
            alert('Link copied to clipboard!');
        }

        function downloadMaterial(type) {
            alert(`Downloading ${type} marketing materials...`);
            // In production, this would download a ZIP file with marketing materials
            window.open(`/api/affiliates/materials/${type}`, '_blank');
        }

        // Initialize
        if (requireAuth()) {
            loadAffiliateData();
        }
    </script>
</body>
</html>
